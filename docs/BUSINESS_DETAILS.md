# 业务详细设计文档

## 1. 用户场景与业务流程

### 1.1 学生使用场景

#### 场景1：课堂跟读

**背景：**

- 老师在课堂上使用投影仪展示二维码
- 学生使用手机扫码跟读

**流程：**

1. 老师打开课本对应章节，展示二维码
2. 学生扫描二维码
3. 系统识别二维码，跳转到播放页
4. 如未登录，显示快速登录/游客模式选项
5. 学生选择游客模式或快速登录
6. 音频自动开始播放
7. 学生跟读，可以使用AB循环功能重复练习
8. 老师可以控制播放进度

**关键需求：**

- 扫码响应速度 < 1秒
- 支持多人同时扫码（100+并发）
- 游客模式无需注册即可使用
- 播放器界面简洁，适合课堂使用

#### 场景2：家庭自学

**背景：**

- 学生在家使用纸质课本配套二维码学习
- 需要记录学习进度

**流程：**

1. 学生打开课本，扫描章节二维码
2. 使用账号登录
3. 系统加载上次学习进度（断点续播）
4. 学生开始学习，可以调整播放速度
5. 系统自动记录学习时长和进度
6. 学生可以收藏重点内容
7. 完成学习后，系统更新学习统计

**关键需求：**

- 断点续播功能
- 学习进度自动保存
- 支持变速播放（0.5x-2.0x）
- 收藏功能
- 学习数据统计

#### 场景3：课后复习

**背景：**

- 学生需要复习之前学过的内容
- 不使用二维码，直接通过应用浏览

**流程：**

1. 学生打开应用，登录账号
2. 浏览课本列表，选择对应课本
3. 查看单元列表，选择需要复习的单元
4. 查看课程列表，选择具体课程
5. 开始播放，使用AB循环重点练习
6. 查看学习历史，继续上次未完成的内容
7. 查看收藏列表，复习重点内容

**关键需求：**

- 清晰的内容组织结构
- 学习历史记录
- 收藏列表
- AB循环功能
- 播放列表自动播放

### 1.2 管理员使用场景

#### 场景1：内容上传

**背景：**

- 新学期开始，需要上传新课本的音频内容
- 需要批量上传多个音频文件

**流程：**

1. 管理员登录后台管理系统
2. 创建新课本（填写课本信息，上传封面）
3. 在课本下创建单元
4. 在单元下创建课程
5. 批量上传音频文件（拖拽上传）
6. 系统自动识别音频时长
7. 上传字幕文件（可选）
8. 系统自动生成二维码
9. 预览和测试音频播放
10. 发布内容

**关键需求：**

- 批量上传功能（最多20个文件）
- 上传进度显示
- 音频格式自动转换
- 自动提取音频时长
- 二维码自动生成
- 内容预览功能

#### 场景2：二维码批量导出

**背景：**

- 需要为纸质课本印刷配套二维码
- 需要批量生成并导出为PDF

**流程：**

1. 管理员进入二维码管理页面
2. 选择需要导出的课本或单元
3. 自定义二维码样式（Logo、颜色、大小）
4. 选择导出模板（A4纸，每页6个）
5. 预览导出效果
6. 点击导出，生成PDF文件
7. 下载PDF文件
8. 发送给印刷厂

**关键需求：**

- 批量选择功能
- 二维码样式自定义
- 多种导出模板
- PDF生成速度快
- 高清二维码图片

#### 场景3：数据分析

**背景：**

- 需要了解用户使用情况
- 需要优化内容和功能

**流程：**

1. 管理员进入数据统计页面
2. 查看用户活跃度统计
   - 日活跃用户（DAU）
   - 月活跃用户（MAU）
   - 新增用户趋势
3. 查看内容播放统计
   - 热门音频排行
   - 播放次数统计
   - 平均播放时长
4. 查看用户学习数据
   - 平均学习时长
   - 学习完成率
   - 用户留存率
5. 导出数据报表
6. 根据数据优化内容和功能

**关键需求：**

- 实时数据统计
- 数据可视化（图表）
- 数据导出功能
- 多维度数据分析

---

## 2. 核心业务规则

### 2.1 内容访问控制

#### 公开内容

- 所有用户（包括游客）都可以访问
- 通过二维码扫码访问
- 不记录学习数据

#### 需要登录的内容

- 需要注册账号才能访问
- 记录学习进度和数据
- 支持收藏和历史记录

#### 权限验证规则

```
IF 用户未登录 AND 内容为公开:
    允许访问，不记录数据
ELSE IF 用户未登录 AND 内容需要登录:
    跳转到登录页面
ELSE IF 用户已登录:
    允许访问，记录学习数据
```

### 2.2 学习进度计算

#### 课程完成度

```
完成度 = (播放时长 / 音频总时长) * 100%

IF 完成度 >= 80%:
    标记为已完成
ELSE:
    标记为学习中
```

#### 学习时长统计

- 只统计实际播放时长
- 暂停时不计入
- 快进不重复计算
- 每次播放结束后更新统计

#### 连续学习天数

```
IF 今天有学习记录 AND 昨天有学习记录:
    连续天数 += 1
ELSE IF 今天有学习记录 AND 昨天无学习记录:
    连续天数 = 1
ELSE:
    连续天数不变
```

### 2.3 二维码生成规则

#### Token生成

```
token = generateUUID() + timestamp
格式: XXXXXX-XXXXXX (12位字符)
```

#### URL格式

```
https://domain.com/play?code={token}
```

#### 二维码有效期

- 默认永久有效
- 可设置有效期（可选）
- 过期后需要重新生成

#### 二维码样式

- 默认样式：黑白，无Logo
- 自定义样式：
  - Logo（中心位置，最大30%面积）
  - 颜色（前景色、背景色）
  - 大小（200x200 - 1000x1000）
  - 边框（可选）

### 2.4 音频文件管理

#### 支持格式

- MP3（推荐）
- M4A
- WAV
- AAC

#### 文件大小限制

- 单个文件：最大100MB
- 批量上传：最多20个文件，总大小不超过500MB

#### 存储策略

- 上传后自动转码为MP3格式（128kbps）
- 存储在Supabase Storage
- 使用CDN加速访问
- 自动生成缩略图（波形图，可选）

#### 文件命名规则

```
{textbook_id}/{unit_id}/{lesson_id}_{timestamp}.mp3
```

### 2.5 字幕文件管理

#### 支持格式

- SRT（推荐）
- VTT
- TXT（纯文本）

#### 字幕同步

- 使用时间戳同步
- 支持中英文对照
- 点击字幕跳转到对应位置

#### 字幕格式示例

```srt
1
00:00:00,000 --> 00:00:03,000
Hello, how are you?
你好，你好吗？

2
00:00:03,000 --> 00:00:06,000
I'm fine, thank you.
我很好，谢谢。
```

---

## 3. 数据统计与分析

### 3.1 用户行为分析

#### 播放行为

- 播放次数
- 播放时长
- 播放完成率
- 播放速度偏好
- AB循环使用频率

#### 学习行为

- 学习时长
- 学习频率
- 学习时段分布
- 课程完成度
- 收藏行为

#### 访问行为

- 扫码访问次数
- 直接访问次数
- 分享次数
- 页面停留时长

### 3.2 内容分析

#### 热门内容

- 播放次数排行
- 收藏次数排行
- 分享次数排行
- 完成率排行

#### 内容质量

- 平均播放完成率
- 用户反馈（可选）
- 播放时长分布

### 3.3 用户留存分析

#### 留存率计算

```
次日留存率 = (第2天活跃用户数 / 第1天新增用户数) * 100%
7日留存率 = (第7天活跃用户数 / 第1天新增用户数) * 100%
30日留存率 = (第30天活跃用户数 / 第1天新增用户数) * 100%
```

#### 流失预警

- 连续7天未登录：发送提醒通知
- 连续30天未登录：标记为流失用户

---

## 4. 通知与提醒

### 4.1 学习提醒

#### 每日学习提醒

- 时间：用户设置的学习时间
- 内容：提醒用户继续学习
- 渠道：应用内通知、邮件（可选）

#### 学习目标提醒

- 设置每日学习目标（如30分钟）
- 未完成时发送提醒
- 完成时发送鼓励

### 4.2 系统通知

#### 内容更新通知

- 新课本上线
- 新单元更新
- 内容修正

#### 功能更新通知

- 新功能上线
- 功能优化
- 系统维护通知

---

## 5. 用户激励机制

### 5.1 学习成就（后续迭代）

#### 成就类型

- 学习时长成就（累计10小时、50小时、100小时）
- 连续学习成就（连续7天、30天、100天）
- 课程完成成就（完成10个、50个、100个课程）
- 早起学习成就（早上6-8点学习）

#### 成就奖励

- 虚拟徽章
- 学习报告分享
- 排行榜展示

### 5.2 学习排行榜（后续迭代）

#### 排行榜类型

- 学习时长排行
- 课程完成数排行
- 连续学习天数排行

#### 排行榜范围

- 全站排行
- 年级排行
- 学校排行（可选）

---

## 6. 内容审核机制

### 6.1 音频审核

#### 自动审核

- 音频时长检查（不超过30分钟）
- 音频格式检查
- 音频质量检查（采样率、比特率）

#### 人工审核

- 内容合规性检查
- 音质检查
- 字幕准确性检查

### 6.2 用户内容审核（如有评论功能）

#### 敏感词过滤

- 自动过滤敏感词
- 人工审核可疑内容

#### 举报机制

- 用户可以举报不当内容
- 管理员审核处理

---

## 7. 数据备份与恢复

### 7.1 备份策略

#### 数据库备份

- 每日全量备份
- 每小时增量备份
- 保留30天备份

#### 文件备份

- 音频文件自动备份到多个存储节点
- 每周全量备份
- 保留90天备份

### 7.2 灾难恢复

#### 恢复流程

1. 检测系统故障
2. 切换到备用系统
3. 从最近备份恢复数据
4. 验证数据完整性
5. 恢复服务

#### 恢复时间目标（RTO）

- 数据库：< 1小时
- 文件存储：< 2小时
- 完整系统：< 4小时

---

## 8. 运营策略

### 8.1 内容运营

#### 内容规划

- 按学期规划内容上传
- 优先上传热门课本
- 定期更新内容

#### 内容质量

- 音频清晰度标准
- 字幕准确性标准
- 定期质量检查

### 8.2 用户运营

#### 用户增长

- 学校合作推广
- 教师推荐
- 家长口碑传播
- 社交媒体推广

#### 用户活跃

- 每日学习提醒
- 学习成就激励
- 学习报告分享
- 社区互动（后续）

### 8.3 数据运营

#### 数据监控

- 实时监控关键指标
- 异常数据预警
- 定期数据分析报告

#### 数据驱动优化

- 根据用户行为优化功能
- 根据内容数据优化内容
- A/B测试新功能

---

## 9. 商业模式（可选）

### 9.1 免费模式

- 基础功能免费
- 部分内容免费
- 广告支持（可选）

### 9.2 付费模式（后续考虑）

- 会员订阅
  - 去除广告
  - 离线下载
  - 高级功能
  - 专属内容
- 内容付费
  - 精品课程
  - 专业内容
- 学校/机构版
  - 批量账号
  - 数据分析
  - 定制功能

---

## 10. 合规与版权

### 10.1 版权管理

#### 内容来源

- 自有版权内容
- 授权内容
- 公开版权内容

#### 版权声明

- 每个课本标注版权信息
- 用户协议中明确版权条款
- 侵权处理机制

### 10.2 隐私保护

#### 数据收集

- 明确告知用户收集的数据
- 获得用户同意
- 最小化数据收集

#### 数据使用

- 仅用于服务改进
- 不出售用户数据
- 不用于其他商业目的

#### 数据安全

- 数据加密存储
- 访问权限控制
- 定期安全审计

### 10.3 未成年人保护

#### 内容审核

- 严格审核内容适宜性
- 过滤不当内容

#### 使用时长控制

- 提醒长时间使用
- 家长监控功能（可选）

#### 隐私保护

- 不收集敏感个人信息
- 家长同意机制
